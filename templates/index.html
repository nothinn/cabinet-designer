<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cabinet Designer Web UI</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; display: flex; height: 100vh; background: #f0f0f0; }
        .sidebar { width: 400px; background: #fff; padding: 20px; overflow-y: auto; border-right: 1px solid #ccc; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .preview { flex: 1; display: flex; align-items: center; justify-content: center; background: #e0e0e0; padding: 20px; }
        .preview img { max-width: 100%; max-height: 100%; box-shadow: 0 0 20px rgba(0,0,0,0.2); background: white; }
        
        h1, h2, h3 { margin-top: 0; }
        .card { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 5px; background: #fafafa; }
        .card h3 { margin-bottom: 5px; font-size: 1.1em; display: flex; justify-content: space-between; }
        
        .row { display: flex; gap: 10px; margin-bottom: 5px; align-items: center; }
        button { cursor: pointer; padding: 5px 10px; }
        input[type="number"] { width: 60px; padding: 5px; }
        
        .btn-danger { background: #ffdddd; border: 1px solid #ffaaaa; color: #a00; }
        .btn-primary { background: #ddf; border: 1px solid #aab; color: #00a; }
        
        .controls-group { margin-top: 5px; padding-top: 5px; border-top: 1px solid #eee; }
        .badge { display: inline-block; padding: 2px 5px; font-size: 0.8em; border-radius: 3px; background: #eee; }
        .badge.on { background: #dca; }
    </style>
</head>
<body>

<div class="sidebar">
    <h1>Cabinet Designer</h1>
    
    <div class="card">
        <h3>Save / Load</h3>
        <form action="{{ url_for('save') }}" method="post" class="row">
            <input type="text" name="filename" placeholder="design_name" required style="flex:1;">
            <button type="submit">Save</button>
        </form>
        
        <form action="{{ url_for('load') }}" method="post" class="row" style="margin-top:5px;">
            <select name="filename" style="flex:1;">
                <option value="" disabled selected>Load saved...</option>
                {% for f in saved_files %}
                    <option value="{{ f }}">{{ f }}</option>
                {% endfor %}
            </select>
            <button type="submit">Load</button>
        </form>
    </div>

    <div class="card">
        <h3>Global Settings</h3>
        <form action="{{ url_for('set_height') }}" method="post" class="row">
            <label>Total Height (cm):</label>
            <input type="number" name="height" value="{{ designer.total_height }}" step="0.1">
            <button type="submit">Set</button>
        </form>
        <form action="{{ url_for('set_plinth_height') }}" method="post" class="row">
            <label>Plinth Height (cm):</label>
            <input type="number" name="height" value="{{ designer.plinth_height }}" step="0.1">
            <button type="submit">Set</button>
        </form>
        <div class="row" style="margin-top:10px;">
            <form action="{{ url_for('add_column') }}" method="post" style="display:inline;">
                <input type="hidden" name="width" value="40">
                <button type="submit">+ 40cm Col</button>
            </form>
            <form action="{{ url_for('add_column') }}" method="post" style="display:inline;">
                <input type="hidden" name="width" value="60">
                <button type="submit">+ 60cm Col</button>
            </form>
            <form action="{{ url_for('add_column') }}" method="post" style="display:inline;">
                <input type="hidden" name="width" value="80">
                <button type="submit">+ 80cm Col</button>
            </form>
        </div>
        <form action="{{ url_for('reset') }}" method="post" style="margin-top:10px;">
             <button type="submit" class="btn-danger">Reset All</button>
        </form>
    </div>

    <h2>Columns</h2>
    {% for i, col in enumerate(designer.columns) %}
    {% set is_merged_target = (i > 0 and designer.columns[i-1].merge_right) %}
    <div class="card" style="{{ 'background: #fdfdfd; opacity: 0.9;' if is_merged_target else '' }}">
        <h3>
            Column #{{ i + 1 }} ({{ col.width }}cm)
            {% if is_merged_target %}
                <span class="badge on" style="margin-left:10px; font-size: 0.8em; vertical-align: middle;">MERGED &larr;</span>
            {% endif %}
            
            <div>
                <form action="{{ url_for('move_column') }}" method="post" style="display:inline;">
                    <input type="hidden" name="index" value="{{ i }}">
                    <input type="hidden" name="direction" value="left">
                    <button type="submit" {{ 'disabled' if i == 0 }}>&uarr;</button>
                </form>
                <form action="{{ url_for('move_column') }}" method="post" style="display:inline;">
                    <input type="hidden" name="index" value="{{ i }}">
                    <input type="hidden" name="direction" value="right">
                    <button type="submit" {{ 'disabled' if i == len(designer.columns)-1 }}>&darr;</button>
                </form>
                <form action="{{ url_for('remove_column') }}" method="post" style="display:inline;">
                    <input type="hidden" name="index" value="{{ i }}">
                    <button type="submit" class="btn-danger">X</button>
                </form>
            </div>
        </h3>
        
        <div class="controls-group">
            <form action="{{ url_for('toggle_top') }}" method="post" style="display:inline;">
                <input type="hidden" name="index" value="{{ i }}">
                <button type="submit" class="btn-primary" {{ 'disabled' if is_merged_target }}>Top Section: {{ 'ON' if col.has_top else 'OFF' }}</button>
            </form>
            {% if i < len(designer.columns) - 1 %}
            <form action="{{ url_for('toggle_merge') }}" method="post" style="display:inline;">
                <input type="hidden" name="index" value="{{ i }}">
                <button type="submit">Merge Right: {{ 'YES' if col.merge_right else 'NO' }}</button>
            </form>
            {% endif %}
        </div>

        <div class="controls-group">
            <strong>Drawers:</strong> {{ len(col.drawers) }}
            <form action="{{ url_for('configure_drawers') }}" method="post" class="row">
                <input type="hidden" name="index" value="{{ i }}">
                <label>Count:</label>
                <input type="number" name="count" value="{{ len(col.drawers) }}" min="0" max="5" style="width:40px;">
                <label>H:</label>
                <input type="number" name="height" value="{{ col.drawers[0].height if col.drawers else 20.0 }}" step="0.1" style="width:50px;">
                <button type="submit">Set</button>
            </form>
        </div>

        {% if is_merged_target %}
        <div class="controls-group" style="color: #888; font-style: italic; padding: 10px 0;">
            This column's upper section is merged with the column to the left. 
            Shelves and compartments are controlled by Column #{{ i }}.
        </div>
        {% else %}
        <div class="controls-group">
            <strong>Shelves:</strong>
            <table style="width:100%; border-collapse: collapse; font-size: 0.9em;">
                {% if not col.shelf_heights %}
                    <tr><td>No shelves</td></tr>
                {% else %}
                    {% for j, h in enumerate(col.shelf_heights) %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 3px;">#{{ j+1 }}</td>
                        <td style="padding: 3px;"><strong>{{ h|round(1) }}</strong> cm</td>
                        <td style="text-align: right; padding: 3px;">
                            <form action="{{ url_for('move_shelf') }}" method="post" style="display:inline;">
                                <input type="hidden" name="col_index" value="{{ i }}">
                                <input type="hidden" name="shelf_index" value="{{ j }}">
                                <input type="hidden" name="amount" value="5">
                                <button type="submit" style="padding: 2px 5px;">&uarr;</button>
                            </form>
                            <form action="{{ url_for('move_shelf') }}" method="post" style="display:inline;">
                                <input type="hidden" name="col_index" value="{{ i }}">
                                <input type="hidden" name="shelf_index" value="{{ j }}">
                                <input type="hidden" name="amount" value="-5">
                                <button type="submit" style="padding: 2px 5px;">&darr;</button>
                            </form>
                            <form action="{{ url_for('remove_shelf') }}" method="post" style="display:inline;">
                                <input type="hidden" name="col_index" value="{{ i }}">
                                <input type="hidden" name="shelf_index" value="{{ j }}">
                                <button type="submit" class="btn-danger" style="padding: 2px 5px;">X</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                {% endif %}
            </table>
            
            <div style="margin-top: 5px;">
                <form action="{{ url_for('set_shelves_count') }}" method="post" class="row" style="margin-bottom:2px;">
                    <input type="hidden" name="index" value="{{ i }}">
                    <label style="font-size:0.9em;">Spaces:</label>
                    <input type="number" name="count" value="3" min="1" max="10" style="width:30px; padding: 2px;">
                    <button type="submit" style="padding: 2px 5px;">Reset Even</button>
                </form>
                
                <form action="{{ url_for('add_shelf') }}" method="post" class="row">
                    <input type="hidden" name="index" value="{{ i }}">
                    <input type="number" name="height" step="0.1" placeholder="H (cm)" style="width:50px; padding: 2px;">
                    <button type="submit" style="padding: 2px 5px;">Add</button>
                </form>
            </div>
        </div>

        <div class="controls-group">
            <strong>Vertical Dividers (Compartments):</strong>
            <div style="font-size: 0.9em; margin-top: 5px;">
                {% for space_id in range(len(col.shelf_heights) + 1) %}
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px;">
                    <span>Space {{ space_id }} ({{ 'Top' if space_id == len(col.shelf_heights) else 'Mid' if space_id > 0 else 'Bot' }}):</span>
                    <form action="{{ url_for('subdivide_compartment') }}" method="post" style="margin:0;">
                        <input type="hidden" name="col_index" value="{{ i }}">
                        <input type="hidden" name="space_id" value="{{ space_id }}">
                        <button type="submit" style="padding: 2px 5px; {{ 'background-color: #dca;' if space_id in col.vertical_dividers else '' }}">
                            {{ 'DIVIDER ON' if space_id in col.vertical_dividers else 'Toggle' }}
                        </button>
                    </form>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>

<div class="preview">
    <img src="{{ url_for('image') }}?t={{ time.time() }}" alt="Cabinet Preview">
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        var sidebar = document.querySelector('.sidebar');
        var scrollPos = localStorage.getItem('sidebarScrollPos');
        if (scrollPos) {
            sidebar.scrollTop = scrollPos;
        }
        
        window.addEventListener('beforeunload', function() {
            localStorage.setItem('sidebarScrollPos', sidebar.scrollTop);
        });
    });
</script>

</body>
</html>
